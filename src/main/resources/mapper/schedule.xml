<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.kcc.trioffice.domain.schedule.mapper.ScheduleMapper">


  <select id="getEmployeeSchedules" parameterType="map" resultType="com.kcc.trioffice.domain.schedule.dto.EmployeeSchedules">
  select name
      ,started_dt as startedDt
      ,ended_dt as endedDt
  from schedule
  where schedule_id IN (SELECT i.SCHEDULE_INVITE_ID AS scheduleInviteId
                      from schedule_invite i
                      where is_participated = 2 and employee_id = (
                                                  select employee_id
                                                  from employee
                                                  where email = #{employeeId}
                                                  )
                      )
      and started_dt <![CDATA[>]]> ADD_MONTHS(TO_DATE(#{startDate}, 'YYYY-MM-DD'), -1)
      and ended_dt <![CDATA[<=]]> ADD_MONTHS(TO_DATE(#{endDate}, 'YYYY-MM-DD'), 1)
  </select>

 <insert id="saveSchedule" parameterType="map" >
    <selectKey keyProperty="saveSchedule.scheduleId" resultType="long" order="BEFORE">
        SELECT seq_schedule.nextval FROM dual
    </selectKey>
    INSERT INTO schedule 
    (schedule_id, name, started_dt, ended_dt, contents, writer, created_dt, modifier, modifed_dt, is_deleted)
    VALUES (#{saveSchedule.scheduleId}, 
            #{saveSchedule.name}, 
            #{startedDt}, 
            #{endedDt}, 
            #{saveSchedule.contents}, 
            #{saveSchedule.writer}, 
            sysdate, 
            #{saveSchedule.modifier}, 
            sysdate, 
            #{saveSchedule.isDeleted})
  </insert>




  <insert id="saveScheduleInvite" parameterType="com.kcc.trioffice.domain.schedule.dto.SaveSchedule">
    <foreach collection="employeeIds" item="employeeId" separator=";" open="DECLARE BEGIN" close="; END;">
        <if test="employeeId != null">
            INSERT INTO schedule_invite 
            (schedule_invite_id, employee_id, is_participated, writer, created_dt, modifier, modified_dt, is_deleted)
            VALUES (#{scheduleId}, #{employeeId}, 2, #{writer}, sysdate, #{modifier}, sysdate, #{isDeleted})
        </if>
    </foreach>
</insert>

  
</mapper>